#!/bin/bash
set -e

echo "üöÄ –°–±–æ—Ä–∫–∞ –¥–ª—è DigitalOcean –±–µ–∑ SQLite –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ package.json
cp package.json package.json.backup

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —Ç–æ–ª—å–∫–æ —Å 3 –±–∞–∑–æ–≤—ã–º–∏ –ø–∞–∫–µ—Ç–∞–º–∏
cp package.digitalocean.minimal-core.json package.json

echo "‚úÖ Package.json –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ production –≤–µ—Ä—Å–∏—é –±–µ–∑ SQLite"

# –û—á–∏—â–∞–µ–º node_modules –∏ package-lock.json –¥–ª—è —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
rm -rf node_modules package-lock.json

echo "üßπ –û—á–∏—â–µ–Ω—ã node_modules –∏ package-lock.json"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–µ–∑ SQLite
npm install

echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–µ–∑ SQLite"

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
npm run build

echo "üèóÔ∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ"

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π package.json –¥–ª—è development
cp package.json.backup package.json

echo "üîÑ –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π package.json –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

echo "‚úÖ –°–±–æ—Ä–∫–∞ –¥–ª—è DigitalOcean –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üìÅ –ì–æ—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ dist/"

# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
cp quick-db-check.js dist/
cp check-database-connection.js dist/

echo "üîß –°–∫—Ä–∏–ø—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ dist/"
echo "üê≥ –ú–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å –≤ DigitalOcean"
echo ""
echo "üìã –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ production:"
echo "   node quick-db-check.js - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
echo "   node check-database-connection.js - –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"