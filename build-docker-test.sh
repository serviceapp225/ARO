#!/bin/bash

echo "üê≥ –¢–µ—Å—Ç —Å–±–æ—Ä–∫–∏ Docker –¥–ª—è DigitalOcean..."

# –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
docker rmi autobid-tj:test 2>/dev/null || true

# –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
docker build -t autobid-tj:test .

if [ $? -eq 0 ]; then
    echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–±—Ä–∞–∑–∞
    echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–±—Ä–∞–∑–∞..."
    docker run --rm autobid-tj:test ls -la /app/dist
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫
    echo "üöÄ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (5 —Å–µ–∫—É–Ω–¥)..."
    timeout 5s docker run --rm -p 8080:8080 autobid-tj:test || true
    
    echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –û–±—Ä–∞–∑ –≥–æ—Ç–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è –≤ DigitalOcean!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞!"
    exit 1
fi