#!/bin/bash

# AutoBid.TJ - –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ VPS 188.166.61.86
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π AutoBid.TJ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ AutoBid.TJ..."

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl stop autobid-3001.service || true

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
sudo cp -r /var/www/autobid /var/www/autobid-backup-$(date +%Y%m%d-%H%M%S) || true

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
sudo mkdir -p /var/www/autobid/{dist,uploads,node_modules}
sudo mkdir -p /var/log/autobid

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sudo cp dist/index.js /var/www/autobid/dist/
sudo cp -r dist/public /var/www/autobid/dist/
sudo cp package.json /var/www/autobid/
sudo cp -r node_modules /var/www/autobid/
sudo cp -r uploads /var/www/autobid/ 2>/dev/null || true

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è production
echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
sudo tee /var/www/autobid/.env > /dev/null <<EOF
NODE_ENV=production
PORT=3001
HOST=0.0.0.0
DATABASE_URL=postgresql://autobid_user:AutoBid2025@localhost:5432/autobid_db

# SMS API Configuration
SMS_API_URL=https://oson.tj/smsservice.php
SMS_USERNAME=your_username
SMS_PASSWORD=your_password

# Session Secret
SESSION_SECRET=$(openssl rand -hex 32)

# File Upload Settings
MAX_FILE_SIZE=10485760
UPLOAD_PATH=/var/www/autobid/uploads

# Cache Settings
CACHE_TTL=3600
ENABLE_CACHE=true

# Logging
LOG_LEVEL=info
LOG_FILE=/var/log/autobid/app.log
EOF

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
echo "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π..."
sudo chown -R www-data:www-data /var/www/autobid
sudo chmod -R 755 /var/www/autobid
sudo chmod 644 /var/www/autobid/.env

# –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞..."
sudo tee /etc/systemd/system/autobid-full.service > /dev/null <<EOF
[Unit]
Description=AutoBid.TJ Full Application
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/autobid
Environment=NODE_ENV=production
Environment=PORT=3001
EnvironmentFile=/var/www/autobid/.env
ExecStart=/usr/bin/node dist/index.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=autobid-full

# –õ–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤
LimitNOFILE=65536
LimitNPROC=32768

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/www/autobid/uploads /var/log/autobid

[Install]
WantedBy=multi-user.target
EOF

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üåê –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
sudo tee /etc/nginx/sites-available/autobid > /dev/null <<EOF
server {
    listen 80;
    server_name 188.166.61.86;
    
    # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    client_max_body_size 50M;
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    root /var/www/autobid/dist/public;
    index index.html;
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    location /assets/ {
        alias /var/www/autobid/dist/public/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        gzip on;
        gzip_types text/css application/javascript image/svg+xml;
    }
    
    # API –∑–∞–ø—Ä–æ—Å—ã
    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }
    
    # WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    location /ws {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }
    
    # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    location /uploads/ {
        alias /var/www/autobid/uploads/;
        expires 30d;
        add_header Cache-Control "public";
    }
    
    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã - SPA
    location / {
        try_files \$uri \$uri/ /index.html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # Gzip —Å–∂–∞—Ç–∏–µ
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    access_log /var/log/nginx/autobid.access.log;
    error_log /var/log/nginx/autobid.error.log;
}
EOF

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sudo systemctl daemon-reload
sudo systemctl enable autobid-full.service
sudo systemctl start autobid-full.service

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
sudo nginx -t && sudo systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
echo "=== PostgreSQL ==="
sudo systemctl status postgresql --no-pager -l

echo "=== AutoBid Application ==="
sudo systemctl status autobid-full --no-pager -l

echo "=== Nginx ==="
sudo systemctl status nginx --no-pager -l

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö endpoints
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:"
curl -I http://localhost/ 2>/dev/null | head -1

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ API health:"
curl -s http://localhost/api/health 2>/dev/null || echo "API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π IP:"
curl -I http://188.166.61.86/ 2>/dev/null | head -1

# –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º
if ! systemctl is-active --quiet autobid-full; then
    echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –õ–æ–≥–∏:"
    sudo journalctl -u autobid-full --no-pager -l --since "5 minutes ago"
fi

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìç –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:"
echo "   - –û—Å–Ω–æ–≤–Ω–æ–π URL: http://188.166.61.86"
echo "   - –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø: http://188.166.61.86:3001"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: sudo systemctl status autobid-full"
echo "   - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: sudo journalctl -u autobid-full -f"
echo "   - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: sudo systemctl restart autobid-full"
echo ""
echo "üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: PostgreSQL autobid_db (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: autobid_user)"
echo ""