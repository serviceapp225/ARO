# SMS Integration Guide - OSON SMS Service

## Обзор

Система полностью интегрирована с SMS-сервисом OSON SMS для отправки:
- Кодов подтверждения при входе в систему
- Уведомлений о перебитых ставках с текстом "Ваша ставка перебита"

## ⚠️ ОБНОВЛЕНИЕ API (Январь 2025)

OSON SMS изменили формат API с POST на GET запросы. Система обновлена для работы с новым форматом.

## Настройка в продакшене

### 1. Переменные окружения

Добавьте следующие переменные в ваш продакшн environment:

```bash
SMS_LOGIN=zarex
SMS_HASH=a6d5d8b47551199899862d6d768a4cb1
SMS_SENDER=OsonSMS
SMS_SERVER=https://api.osonsms.com/sendsms.php
```

### 2. Новый формат API

API теперь использует GET запросы с параметрами в URL:

```
GET https://api.osonsms.com/sendsms.php?from=OsonSMS&phone_number=903331332&msg=Kod:%20123456&str_hash=8ac95b524e5cca4a115c691e31f6726068f77881d9f7ba4075392b755a152d56&txn_id=autobid_1752660001234&login=zarex
```

### 3. Формат номера телефона

Номера теперь должны быть в 9-значном формате без кода страны:
- Входящий: `+992903331332` → Отправляемый: `903331332`
- Входящий: `992903331332` → Отправляемый: `903331332`

### 2. Автоматическая активация

При наличии всех переменных окружения:
- SMS отправляются через реальный OSON SMS API
- Используется sha256 подпись для безопасности

При отсутствии переменных:
- Система автоматически переключается в демо-режим
- Коды логируются в консоль
- Никакие реальные SMS не отправляются

## Техническая реализация

### Аутентификация (sendSMSCode)

```typescript
// Функция для отправки кодов подтверждения
async function sendSMSCode(phoneNumber: string, code: string)
```

**Текст SMS:** `Ваш код подтверждения AUTOBID.TJ: {code}`

### Уведомления о ставках (sendSMSNotification)

```typescript
// Функция для отправки уведомлений
async function sendSMSNotification(phoneNumber: string, message: string)
```

**Текст SMS:** `Ваша ставка перебита! {carTitle} - новая ставка {amount} сомони. Сделайте новую ставку на AUTOBID.TJ`

### Генерация подписи

Согласно спецификации OSON SMS (формула не изменилась):
```
str_hash = sha256(txn_id + ";" + login + ";" + from + ";" + phone_number + ";" + pass_salt_hash)
```

### Параметры GET запроса

```javascript
// Новый формат - GET с параметрами в URL
const apiUrl = new URL(SMS_SERVER);
apiUrl.searchParams.set('from', SMS_SENDER);
apiUrl.searchParams.set('phone_number', phone_number); // 9-значный формат
apiUrl.searchParams.set('msg', message);
apiUrl.searchParams.set('str_hash', str_hash);
apiUrl.searchParams.set('txn_id', txn_id);
apiUrl.searchParams.set('login', SMS_LOGIN);
```

## Интеграция в систему аукционов

### Места отправки SMS

1. **Аутентификация** (server/routes.ts):
   - POST /api/auth/send-sms
   - Отправка 6-значного кода подтверждения

2. **Уведомления о ставках** (server/routes.ts):
   - POST /api/listings/:id/bids
   - Отправка SMS всем участникам, чьи ставки перебиты

### Обработка ошибок

```javascript
// Логирование в консоль
console.log('[SMS OSON] Отправка SMS на +99290...');
console.log('[SMS OSON] Подпись: a1b2c3d4...');
console.log('[SMS OSON] Ответ сервера: OK');

// Обработка ошибок
if (!response.ok) {
  console.error('[SMS OSON] Ошибка отправки:', response.status);
  return { success: false, message: 'Ошибка SMS сервиса' };
}
```

## Демонстрация работы

### Демо-режим (без переменных окружения)

```
[SMS DEMO] Отправка SMS на +992903331332: 123456
[SMS DEMO] Отправка SMS уведомления на +992903331332: Ваша ставка перебита...
```

### Продакшн-режим (с переменными окружения)

```
[SMS OSON] Отправка SMS на +992903331332 (очищенный: 903331332)
[SMS OSON] Новый GET формат API
[SMS OSON] Полный URL: https://api.osonsms.com/sendsms.php?from=OsonSMS&phone_number=903331332&msg=Kod%3A%20123456&str_hash=abc123...&txn_id=autobid_1752567123456_abc123&login=zarex
[SMS OSON] Ответ сервера: OK
✅ SMS отправлен через новый API oson sms (autobid_1752567123456_abc123)
```

## Безопасность

1. **Генерация подписи** - каждый SMS имеет уникальную подпись
2. **Уникальный txn_id** - предотвращает повторную отправку
3. **Переменные окружения** - учетные данные не хранятся в коде
4. **Обработка ошибок** - не раскрывает внутренние детали API

## Статистика использования

- **Коды подтверждения**: 6-значные коды, TTL 5 минут
- **Попытки входа**: Максимум 3 попытки на номер
- **Уведомления о ставках**: Отправляются всем участникам аукциона
- **Формат номеров**: +992XXXXXXXXX (таджикские номера)

## Готовность к продакшену

✅ Полная интеграция с OSON SMS API  
✅ Автоматическое переключение демо/продакшн режимов  
✅ Обработка ошибок и логирование  
✅ Безопасная генерация подписей  
✅ Интеграция в систему аукционов  
✅ Поддержка как аутентификации, так и уведомлений  

Система готова к использованию с реальными SMS-сообщениями при установке переменных окружения.