# SMS Integration Guide - OSON SMS Service

## Обзор

Система полностью интегрирована с SMS-сервисом OSON SMS для отправки:
- Кодов подтверждения при входе в систему
- Уведомлений о перебитых ставках с текстом "Ваша ставка перебита"

## Настройка в продакшене

### 1. Переменные окружения

Добавьте следующие переменные в ваш продакшн environment:

```bash
SMS_LOGIN=zarex
SMS_HASH=a6d5d8b47551199899862d6d768a4cb1
SMS_SENDER=OsonSMS
SMS_SERVER=https://api.osonsms.com/sendsms_v1.php
```

### 2. Автоматическая активация

При наличии всех переменных окружения:
- SMS отправляются через реальный OSON SMS API
- Используется sha256 подпись для безопасности

При отсутствии переменных:
- Система автоматически переключается в демо-режим
- Коды логируются в консоль
- Никакие реальные SMS не отправляются

## Техническая реализация

### Аутентификация (sendSMSCode)

```typescript
// Функция для отправки кодов подтверждения
async function sendSMSCode(phoneNumber: string, code: string)
```

**Текст SMS:** `Ваш код подтверждения AUTOBID.TJ: {code}`

### Уведомления о ставках (sendSMSNotification)

```typescript
// Функция для отправки уведомлений
async function sendSMSNotification(phoneNumber: string, message: string)
```

**Текст SMS:** `Ваша ставка перебита! {carTitle} - новая ставка {amount} сомони. Сделайте новую ставку на AUTOBID.TJ`

### Генерация подписи

Согласно спецификации OSON SMS:
```
hash = sha256(txn_id + ";" + login + ";" + from + ";" + phone_number + ";" + pass_salt_hash)
```

### Параметры запроса

```javascript
{
  txn_id: "autobid_" + timestamp + "_" + random,
  login: SMS_LOGIN,
  from: SMS_SENDER,
  phone_number: phoneNumber,
  message: message,
  hash: sha256_signature
}
```

## Интеграция в систему аукционов

### Места отправки SMS

1. **Аутентификация** (server/routes.ts):
   - POST /api/auth/send-sms
   - Отправка 6-значного кода подтверждения

2. **Уведомления о ставках** (server/routes.ts):
   - POST /api/listings/:id/bids
   - Отправка SMS всем участникам, чьи ставки перебиты

### Обработка ошибок

```javascript
// Логирование в консоль
console.log('[SMS OSON] Отправка SMS на +99290...');
console.log('[SMS OSON] Подпись: a1b2c3d4...');
console.log('[SMS OSON] Ответ сервера: OK');

// Обработка ошибок
if (!response.ok) {
  console.error('[SMS OSON] Ошибка отправки:', response.status);
  return { success: false, message: 'Ошибка SMS сервиса' };
}
```

## Демонстрация работы

### Демо-режим (без переменных окружения)

```
[SMS DEMO] Отправка SMS на +992903331332: 123456
[SMS DEMO] Отправка SMS уведомления на +992903331332: Ваша ставка перебита...
```

### Продакшн-режим (с переменными окружения)

```
[SMS OSON] Отправка SMS на +992903331332:
[SMS OSON] Сервер: https://api.osonsms.com/sendsms_v1.php
[SMS OSON] Подпись: a1b2c3d4e5f6...
[SMS OSON] Ответ сервера: OK
✅ SMS отправлен через oson sms (autobid_1752567123456_abc123)
```

## Безопасность

1. **Генерация подписи** - каждый SMS имеет уникальную подпись
2. **Уникальный txn_id** - предотвращает повторную отправку
3. **Переменные окружения** - учетные данные не хранятся в коде
4. **Обработка ошибок** - не раскрывает внутренние детали API

## Статистика использования

- **Коды подтверждения**: 6-значные коды, TTL 5 минут
- **Попытки входа**: Максимум 3 попытки на номер
- **Уведомления о ставках**: Отправляются всем участникам аукциона
- **Формат номеров**: +992XXXXXXXXX (таджикские номера)

## Готовность к продакшену

✅ Полная интеграция с OSON SMS API  
✅ Автоматическое переключение демо/продакшн режимов  
✅ Обработка ошибок и логирование  
✅ Безопасная генерация подписей  
✅ Интеграция в систему аукционов  
✅ Поддержка как аутентификации, так и уведомлений  

Система готова к использованию с реальными SMS-сообщениями при установке переменных окружения.